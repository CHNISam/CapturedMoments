<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠŠå›å¿†æ‹¼å¥½ç»™ä½ </title>
  <style>
    :root {
      --bg-light: #f5f7fa;
      --bg-dark: #1e1f24;
      --card-light: #ffffff33;
      --card-dark: #2b2d3133;
      --blur: 16px;
      --text-light: #222;
      --text-dark: #ddd;
      --primary: #3fa7ff;
      --accent: #ff9e3f;
      --ai-btn-bg: #555;
      --ai-btn-hover-bg: #777;
      --ai-btn-color: #fff;
      --radius: 14px;
      --glass-border: 1px solid rgba(255, 255, 255, .25);
      --select-arrow: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3e%3cpath fill='%23666' d='M0 0l5 6 5-6z'/%3e%3c/svg%3e");
      /* ç™»å½•çª—å£ä¸“ç”¨å˜é‡ */
      --login-bg: #f5f7fa;
      --login-text: #222;
      --login-border: rgba(0,0,0,0.2);
    }
    body.dark {
      --login-bg: #1e1f24;
      --login-text: #ddd;
      --login-border: #3a3f47;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Inter, "PingFang SC", sans-serif;
      transition: .3s background-color, .3s color;
    }
    body {
      background: var(--bg-light);
      color: var(--text-light);
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    a {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }
    .hidden { display: none; }
    /* ===== é¡¶æ  ===== */
    nav {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 22px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(var(--blur));
      border-bottom: var(--glass-border);
    }
    .logo {
      font-weight: 700;
      font-size: 20px;
      letter-spacing: .5px;
      text-align: left;
    }
    .menu { display: flex; gap: 18px; align-items: center; }
    .menu a {
      padding: 6px 12px;
      border-radius: 8px;
      transition: .25s background;
    }
    .menu a:hover { background: rgba(0, 0, 0, .08); }
    body.dark .menu a { color: var(--text-dark); }
    .menu a.on { font-weight: 700; text-decoration: underline; }
    .red { width: 8px; height: 8px; border-radius: 50%; background: #e74c3c; margin-left: 4px; }
    .btn-ghost {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 14px; font-size: 14px;
      border-radius: var(--radius);
      border: var(--glass-border);
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      color: inherit; cursor: pointer;
      transition: .25s background;
    }
    .btn-ghost svg { width: 16px; height: 16px; pointer-events: none; }
    .btn-ghost:hover { background: rgba(0, 0, 0, .08); }
    body.dark .btn-ghost { background: rgba(255, 255, 255, .10); }
    body.dark .btn-ghost:hover { background: rgba(255, 255, 255, .18); }
    .btn-publish {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 20px; font-size: 14px;
      border-radius: var(--radius);
      background: var(--ai-btn-bg); color: var(--ai-btn-color);
      border: none; cursor: pointer;
      transition: .25s background;
    }
    .btn-publish:hover { background: var(--ai-btn-hover-bg); }
    .upload-btn { position: relative; overflow: hidden; }
    .upload-btn input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    /* é€šç”¨ badge æ ·å¼ï¼šç»Ÿä¸€æ•´ä½“å°ºå¯¸ */
    .badge {
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 4px;
      margin-left: 4px;
      color: #fff;
      display: inline-block;
      min-width: 40px;
      text-align: center;
    }
    /* â€œä½ æ‰æ˜¯çŒ«å¨˜â€ï¼šä½¿ç”¨ç²‰ç™½æ¸å˜ï¼Œæ–‡å­—é¢œè‰²è°ƒæ•´ä¸ºé»‘è‰²ä¿è¯é˜…è¯»æ€§ */
    .badge.catgirl {
      background: linear-gradient(135deg, #ead0dd, #ffb6c1);
      color: #fffbfb;
    }
    /* â€œæœ€å¥½çš„å¤§ä½¬â€ï¼šåŠ¨ç”»æ—¶é•¿å»¶é•¿è‡³10sï¼Œä¸åŠ ç²— */
    .badge.best {
      background: linear-gradient(270deg, #3fa7ff, #ff9e3f, #3fa7ff);
      background-size: 400% 400%;
      animation: gradientAnimation 10s ease infinite;
      font-family: 'Orbitron', sans-serif;
      font-weight: normal;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 4px;
    }
    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* â€œä¸ä½©æˆ´â€æ ·å¼ */
    .badge.badge-none {
      background: none;
      border: 1px dashed #aaa;
      color: #aaa;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 10px;
      min-width: 40px;
    }
    .card {
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      border-radius: var(--radius);
      border: var(--glass-border);
      box-shadow: 0 6px 18px #0001;
      padding: 18px;
    }
    h2.big { margin: 70px 0 22px; font-size: 26px; padding-left: 0; }
    #moments { padding: 40px 8%; }
    #new-post textarea {
      resize: none; height: 78px;
      border-radius: var(--radius);
      border: var(--glass-border);
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      padding: 10px; font-size: 14px; width: 100%;
    }
    #preview img { width: 70px; height: 50px; border-radius: 8px; object-fit: cover; }
    #moments-list { display: flex; flex-direction: column; gap: 26px; }
    .post .photos { display: flex; gap: 8px; margin-top: 8px; overflow-x: auto; }
    .post .photos img { width: 96px; height: 68px; border-radius: 8px; object-fit: cover; }
    .post .body p { margin: 0 0 6px; white-space: pre-wrap; line-height: 1.5; }
    .post small { display: block; margin-top: 4px; font-size: 12px; color: #888; }
    .actions { display: flex; gap: 8px; font-size: 13px; margin-top: 8px; align-items: center; color: var(--primary); }
    .actions svg { width: 18px; height: 18px; fill: currentColor; }
    .more { cursor: pointer; font-size: 18px; padding: 2px 6px; border-radius: 50%; transition: .2s background; }
    .more:hover { background: rgba(0, 0, 0, .08); }
    .post-txt.folded { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .toggle { color: var(--primary); cursor: pointer; font-size: 13px; margin-left: 6px; }
    #album { padding: 40px 8%; }
    .album-tabs { display: flex; gap: 16px; margin-bottom: 18px; }
    .album-tabs button {
      background: none; border: none; font-weight: 600; cursor: pointer;
      font-size: 15px; padding: 6px 10px; border-radius: 8px;
      transition: .25s background;
    }
    .album-tabs .on { background: rgba(0, 0, 0, .08); }
    body.dark .album-tabs button { color: var(--text-dark); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 18px; }
    .photo { border-radius: var(--radius); overflow: hidden; position: relative; cursor: pointer; }
    .photo img { width: 100%; height: 120px; object-fit: cover; transition: .3s transform; }
    .photo:hover img { transform: scale(1.05); }
    .photo span { position: absolute; bottom: 6px; left: 6px; background: rgba(0, 0, 0, .45); color: #fff; font-size: 12px; padding: 2px 6px; border-radius: 8px; }
    #settings { padding: 40px 8%; }
    fieldset { border: none; padding: 0; margin: 0 0 24px; }
    legend { font-weight: 600; font-size: 15px; margin-bottom: 8px; }
    .setting-item { display: flex; justify-content: space-between; align-items: center; margin: 12px 0; }
    .setting-item + .setting-item { border-top: 1px solid rgba(0, 0, 0, .08); padding-top: 12px; }
    body.dark .setting-item + .setting-item { border-top: 1px solid rgba(255, 255, 255, .10); }
    .setting-item input[type=text], .setting-item textarea {
      width: 60%; padding: 6px; border-radius: var(--radius);
      border: var(--glass-border);
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      color: inherit;
    }
    select {
      appearance: none; padding: 8px 34px 8px 12px; font-size: 14px;
      border-radius: var(--radius); border: var(--glass-border);
      background: var(--card-light); color: inherit; max-width: 160px;
      background-image: var(--select-arrow);
      background-repeat: no-repeat; background-position: right 10px center;
      backdrop-filter: blur(calc(var(--blur) / 2));
    }
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: flex; justify-content: center; align-items: center;
      opacity: 0; visibility: hidden;
      transition: opacity 0.25s ease;
    }
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    /* ç»Ÿä¸€ Modal å†…å®¹ç›’æ ·å¼ */
    .box {
      background: var(--card-light); backdrop-filter: blur(var(--blur));
      border: var(--glass-border); border-radius: var(--radius);
      max-width: 600px; width: 90%; max-height: 90vh;
      overflow: auto; padding: 20px; position: relative;
    }
    body.dark .box { background: var(--card-dark); }
    /* é’ˆå¯¹å‹‹ç«  Modal å–æ¶ˆå¼¹å‡ºåŠ¨ç”»ï¼ˆé¿å…é—ªçƒï¼‰ */
    #badgeModal .box { animation: none; }
    .close { position: absolute; top: 10px; right: 16px; font-size: 24px; cursor: pointer; }
    #pet { position: fixed; right: 24px; bottom: 24px; width: 90px; user-select: none; cursor: move; z-index: 90; }
    #pet svg { width: 100%; animation: breathe 3s ease-in-out infinite; }
    @keyframes breathe { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    /* æš—é»‘æ¨¡å¼ä¸‹è¾“å…¥æ¡†ã€æ–‡æœ¬åŸŸå’Œä¸‹æ‹‰èœå•æ ·å¼ */
    body.dark input,
    body.dark textarea,
    body.dark select {
      background-color: var(--card-dark);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-dark);
      transition: border-color 0.2s ease;
    }
    body.dark input:focus,
    body.dark textarea:focus {
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 5px rgba(255, 255, 255, 0.15);
      outline: none;
    }
    body.dark select:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.2);
    }
    #bubble {
      position: fixed; right: 110px; bottom: 110px; max-width: 220px;
      background: var(--card-light); backdrop-filter: blur(calc(var(--blur) / 2));
      border: var(--glass-border); border-radius: var(--radius);
      padding: 12px; font-size: 14px; line-height: 1.45;
      box-shadow: 0 4px 12px #0003; transition: opacity .4s, transform .4s;
      opacity: 0; transform: translateY(10px); z-index: 95;
    }
    #bubble.show { opacity: 1; transform: translateY(0); }

    /* ================ ç™»å½• Modalï¼ˆä¸æ•´ä½“ä¸»é¢˜æ­é…ï¼‰ ================ */
    #loginModal {
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
    }
    #loginModal .box {
      background: var(--login-bg);
      color: var(--login-text);
      border: 1px solid var(--login-border);
      box-shadow: 0 0 20px rgba(63, 167, 255, 0.4);
      border-radius: 10px;
      padding: 30px 20px;
      text-align: center;
      width: 350px;
    }
    #loginModal h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-family: 'Roboto', sans-serif;
    }
    #loginModal .avatar {
      margin: 0 10px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    #loginModal .avatar:hover {
      border-color: var(--primary);
    }
    #loginModal .avatar img {
      width: 90px;
      height: 90px;
      object-fit: cover;
    }
    #loginModal .avatar + .avatar {
      margin-left: 20px;
    }
    #loginModal [data-user] {
      cursor: pointer;
    }
    #loginModal #loginPasswordDiv {
      margin-top: 20px;
    }
    #loginModal input[type="password"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #555;
      background: #2b2d31;
      color: #ddd;
      font-size: 14px;
      margin-bottom: 12px;
    }
    #loginModal .btn-publish {
      font-size: 16px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    #loginModal .btn-publish:hover {
      background: #66baff;
    }
    /* ===== å‹‹ç«  Modal ===== */
    #badgeModal .box { animation: none; }
    /* ===== åé¦ˆ Toast ===== */
    #badgeToast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      display: none;
      z-index: 200;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- ===== é¡¶æ  ===== -->
  <nav>
    <div class="logo">æŠŠå›å¿†æ‹¼å¥½ç»™ä½ </div>
    <div class="menu">
      <a href="#moments" id="nav-moments">åŠ¨æ€<span id="nav-dot" class="red hidden"></span></a>
      <a href="#album">ç›¸å†Œ</a>
      <a href="#settings">è®¾ç½®</a>
      <span id="header-name" style="font-weight:600;"></span>
      <a id="logout" class="btn-ghost">é€€å‡º</a>
      <button id="themeBtn" class="btn-ghost">
        <svg id="sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/></svg>
        <svg id="moon" class="hidden" viewBox="0 0 24 24"><path d="M21 12.8A9 9 0 1111.2 3 7 7 0 0021 12.8z"/></svg>
      </button>
    </div>
  </nav>
  
  <!-- ===== åŠ¨æ€ ===== -->
  <section id="moments">
    <h2 class="big">æŠ•ç¨¿</h2>
    <div id="new-post" class="card" style="display:flex;flex-direction:column;gap:12px">
      <textarea id="post-text" placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦"></textarea>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <select id="post-place">
          <option value="">æ— åœ°ç‚¹</option>
          <option>è’™å¾·</option>
          <option>ç’ƒæœˆ</option>
          <option>ç¨»å¦»</option>
          <option>é¡»å¼¥</option>
          <option>çº³å¡”</option>
        </select>
        <label class="btn-ghost upload-btn">
          <svg viewBox="0 0 24 24">
            <path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="post-img" type="file" accept="image/*" multiple>
        </label>
        <button id="publish" class="btn-publish">å‘å¸ƒ</button>
      </div>
      <div id="preview" style="display:flex;gap:8px;overflow-x:auto"></div>
    </div>
    <h2 class="big">åŠ¨æ€</h2>
    <div id="moments-list"></div>
  </section>
  
  <!-- ===== ç›¸å†Œ ===== -->
  <section id="album">
    <h2 class="big">ç›¸å†Œ</h2>
    <div class="album-tabs">
      <button data-tab="time" class="on">æŒ‰æ—¶é—´</button>
      <button data-tab="region">æŒ‰åœ°åŒº</button>
    </div>
    <div id="album-grid" class="grid"></div>
    <div id="album-empty" class="hidden" style="text-align:center;margin-top:30px;color:#888">
      æš‚æ— ç…§ç‰‡ï¼Œå¿«å»ä¸Šä¼ å§~
    </div>
  </section>
  
  <!-- ===== è®¾ç½® ===== -->
  <section id="settings">
    <h2 class="big">è®¾ç½®</h2>
    <div class="card">
      <fieldset>
        <legend>å¤–è§‚</legend>
        <div class="setting-item">
          <span>æš—é»‘æ¨¡å¼</span>
          <input type="checkbox" id="theme-toggle">
        </div>
      </fieldset>
      <fieldset>
        <legend>æ¡Œå®  / LLM</legend>
        <div class="setting-item">
          <span>æ˜¾ç¤ºæ¡Œå® </span>
          <input type="checkbox" id="pet-toggle" checked>
        </div>
        <div class="setting-item">
          <span>æ¡Œå® ç±»å‹</span>
          <select id="pet-type">
            <option value="cat">çŒ«å¨˜</option>
            <option value="bird">é­ˆé¸Ÿ</option>
          </select>
        </div>
        <div class="setting-item">
          <span>å¯ç”¨ LLM</span>
          <input type="checkbox" id="ai-toggle" checked>
        </div>
        <div class="setting-item">
          <span id="prompt-label">æ¡Œå®  Prompt</span>
          <input id="pet-prompt" value="å–µï½ è®°å¾—å–æ°´å–”ï¼">
        </div>
      </fieldset>
      <fieldset>
        <legend>è´¦æˆ·</legend>
        <div class="setting-item">
          <span>å¤´åƒ</span>
          <label class="btn-ghost upload-btn">
            <svg viewBox="0 0 24 24">
              <path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2"/>
            </svg>
            <input id="avatar-input" type="file" accept="image/*">
          </label>
        </div>
        <div class="setting-item">
          <span>æˆ‘çš„æ˜µç§°</span>
          <input id="name-me">
        </div>
        <div class="setting-item">
          <span>æ›´æ”¹å¯†ç </span>
          <button id="changePasswordBtn" class="btn-ghost">æ›´æ”¹å¯†ç </button>
        </div>
      </fieldset>
      <fieldset id="badge-field">
        <legend>å‹‹ç« </legend>
        <!-- ä»…æ˜¾ç¤ºæ›´æ¢æŒ‰é’® -->
        <div id="currentBadgeDisplay" class="setting-item" style="flex-direction: row; align-items: center;">
          <button id="changeBadgeBtn" class="btn-ghost">æ›´æ¢å‹‹ç« </button>
        </div>
      </fieldset>
    </div>
  </section>
  
  <!-- ===== ç…§ç‰‡ Modal ===== -->
  <div id="photoModal" class="modal">
    <div class="box">
      <span class="close" onclick="hideModal()">Ã—</span>
      <img id="mImg">
      <p id="mMeta" style="margin-top:8px;font-size:14px;color:#888"></p>
    </div>
  </div>
  
  <!-- ===== ç™»å½• Modal ===== -->
  <div id="loginModal" class="modal show">
    <div class="box" style="text-align:center;max-width:340px">
      <h3>é€‰æ‹©ç™»å½•èº«ä»½</h3>
      <div class="avatar-container" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
        <div class="avatar" data-user="Furinya">
          <img src="https://placehold.co/90x90?text=F" alt="Furinya">
          <div>Furinya</div>
        </div>
        <div class="avatar" data-user="ç¦»">
          <img src="https://placehold.co/90x90?text=ç¦»" alt="ç¦»">
          <div>ç¦»</div>
        </div>
      </div>
      <div id="loginPasswordDiv" class="hidden">
        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;">
        <button id="loginConfirmBtn" class="btn-publish" style="margin-top:12px;">ç™»å½•</button>
      </div>
    </div>
  </div>
  
  <!-- ===== å‹‹ç«  Modal ===== -->
  <div id="badgeModal" class="modal">
    <div class="box">
      <span class="close" onclick="hideBadgeModal()">Ã—</span>
      <h3>é€‰æ‹©å‹‹ç« </h3>
      <div id="badgeOptions" style="margin: 10px 0;"></div>
      <button id="confirmBadge" class="btn-publish" style="margin-top:12px;">ç¡®è®¤</button>
    </div>
  </div>
  
  <!-- ===== æ›´æ”¹å¯†ç  Modal ===== -->
  <div id="passwordModal" class="modal">
    <div class="box" style="text-align:center;max-width:340px">
      <span class="close" onclick="hidePasswordModal()">Ã—</span>
      <h3>æ›´æ”¹å¯†ç </h3>
      <div style="margin-top:16px;">
        <input type="password" id="oldPassword" placeholder="æ—§å¯†ç " style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;">
        <input type="password" id="newPassword" placeholder="æ–°å¯†ç " style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;">
        <input type="password" id="confirmPassword" placeholder="ç¡®è®¤æ–°å¯†ç " style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;">
        <button id="confirmChangePasswordBtn" class="btn-publish" style="margin-top:12px;">ç¡®è®¤æ›´æ”¹</button>
      </div>
    </div>
  </div>
  
  <!-- ===== æ¡Œå®  & æ°”æ³¡ ===== -->
  <div id="pet"></div>
  <div id="bubble" class="hidden"></div>
  
  <!-- ===== åé¦ˆ Toast ===== -->
  <div id="badgeToast">å‹‹ç« å·²æ›´æ¢</div>
  
  <footer style="text-align:center;padding:24px 0;font-size:13px;color:#777">
    Â© 2025 æŠŠå›å¿†æ‹¼å¥½ç»™ä½ 
  </footer>
  
  <!-- ========= è„šæœ¬ ========= -->
  <script>
    /* ---------- å·¥å…·å‡½æ•° ---------- */
    const $ = s => document.querySelector(s),
          $$ = s => document.querySelectorAll(s),
          store = (k, v) => v === undefined ? JSON.parse(localStorage.getItem(k) || 'null') : localStorage.setItem(k, JSON.stringify(v));

    /* ---------- å…¨å±€æ•°æ® ---------- */
    let posts = store('posts') || [];
    let currentUser = store('currentUser') || null;
    function readKey() { return 'readIds_' + currentUser; }
    let readIds = new Set(store(readKey()) || []);
    
    /* ---------- æ˜¾ç¤ºåç§°å‡½æ•° ---------- */
    const displayName = uid => store('displayName_' + uid) || uid;

    /* ---------- ç”¨æˆ·ç™»å½• ---------- */
    let selectedUser = null;
    $$ ('#loginModal .avatar').forEach(ava => {
      ava.addEventListener('click', () => {
        selectedUser = ava.dataset.user;
        document.getElementById('loginPassword').value = "";
        document.getElementById('loginPasswordDiv').classList.remove('hidden');
      });
    });
    document.getElementById('loginConfirmBtn').onclick = () => {
      const inputPwd = document.getElementById('loginPassword').value;
      let storedPwd = store('password_' + selectedUser);
      if (!storedPwd) {
        storedPwd = "123456";
        store('password_' + selectedUser, storedPwd);
      }
      if (inputPwd === storedPwd) {
        currentUser = selectedUser;
        store('currentUser', currentUser);
        document.getElementById('loginModal').classList.remove('show');
        readIds = new Set(store(readKey()) || []);
        initAfterLogin();
        syncNameInput();
      } else {
        alert("å¯†ç ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•ï¼");
      }
    };

    if (currentUser) {
      document.getElementById('loginModal').classList.remove('show');
    }

    document.getElementById('logout').onclick = () => { 
      localStorage.removeItem('currentUser'); 
      location.reload(); 
    };

    /* ---------- ä¸»é¢˜è®¾ç½® ---------- */
    const body = document.body,
          themeT = document.getElementById('theme-toggle'),
          sun = document.getElementById('sun'),
          moon = document.getElementById('moon');
    function setTheme(dark) {
      body.classList.toggle('dark', dark);
      themeT.checked = dark;
      sun.classList.toggle('hidden', dark);
      moon.classList.toggle('hidden', !dark);
      localStorage.theme = dark ? 'dark' : 'light';
    }
    setTheme(localStorage.theme === 'dark');
    document.getElementById('themeBtn').onclick = () => setTheme(!body.classList.contains('dark'));
    themeT.onchange = () => setTheme(themeT.checked);

    /* ---------- å¹³æ»‘æ»šåŠ¨ & é«˜äº® ---------- */
    $$('nav .menu a[href^="#"]').forEach(a => a.onclick = e => {
      e.preventDefault();
      document.querySelector(a.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
    });
    const sections = ['moments', 'album', 'settings'].map(id => document.getElementById(id));
    const menuLinks = { moments: document.getElementById('nav-moments'), album: document.querySelector('a[href="#album"]'), settings: document.querySelector('a[href="#settings"]') };
    window.addEventListener('scroll', () => {
      const top = scrollY + 80;
      sections.forEach(sec => {
        const active = top >= sec.offsetTop && top < sec.offsetTop + sec.offsetHeight;
        menuLinks[sec.id].classList.toggle('on', active);
      });
    });

    /* ---------- æ¡Œå® è®¾ç½® ---------- */
    function lockPetFields() {
      const on = document.getElementById('pet-toggle').checked;
      ['pet-type', 'ai-toggle', 'pet-prompt'].forEach(id => document.getElementById(id).disabled = !on);
    }
    document.getElementById('pet-toggle').onchange = lockPetFields;
    lockPetFields();
    // ä¿®æ”¹å¤´åƒä¸Šä¼ ï¼Œä½¿ç”¨ FileReader è½¬æ¢ä¸º Data URL å­˜å‚¨
    document.getElementById('avatar-input').onchange = e => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const url = e.target.result;
        store('avatar-' + currentUser, url);
        renderAvatars();
        renderPosts();
      };
      reader.readAsDataURL(f);
    };
    function renderAvatars() {
      $$ ('.avatar').forEach(a => {
        const saved = store('avatar-' + a.dataset.user);
        if (saved) a.querySelector('img').src = saved;
      });
    }
    renderAvatars();

    /* ---------- æ¡Œå® ä»£ç ï¼ˆç•¥ï¼‰ ---------- */
    const pet = document.getElementById('pet');
    function petSVG(type) {
      return type === 'bird'
        ? `<svg viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="55" fill="#cdeffd" stroke="#333" stroke-width="3"/>
              <path d="M40 70 Q60 90 80 70" stroke="#333" stroke-width="5" fill="none" stroke-linecap="round"/>
              <circle cx="45" cy="55" r="8"/>
              <circle cx="75" cy="55" r="8"/>
            </svg>`
        : `<svg viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="55" fill="#ffe4e1" stroke="#333" stroke-width="3"/>
              <circle cx="45" cy="50" r="10"/>
              <circle cx="75" cy="50" r="10"/>
              <path d="M45 80 Q60 95 75 80" stroke="#333" stroke-width="4" fill="none" stroke-linecap="round"/>
            </svg>`;
    }
    function syncPet() {
      pet.style.display = document.getElementById('pet-toggle').checked ? 'block' : 'none';
      pet.innerHTML = petSVG(document.getElementById('pet-type').value);
    }
    document.getElementById('pet-toggle').onchange = syncPet;
    document.getElementById('pet-type').onchange = syncPet;
    syncPet();
    let ox, oy;
    pet.onmousedown = e => {
      ox = e.offsetX; oy = e.offsetY;
      document.onmousemove = ev => { pet.style.left = ev.pageX - ox + 'px'; pet.style.top = ev.pageY - oy + 'px'; };
      document.onmouseup = () => document.onmousemove = null;
    };

    /* ---------- ä¸Šä¼  / å‘å¸ƒ ---------- */
    const postImg = document.getElementById('post-img'),
          preview = document.getElementById('preview'),
          publishBtn = document.getElementById('publish');
    let draftImgs = [];
    postImg.onchange = e => {
      preview.innerHTML = '';
      draftImgs = [];
      [...e.target.files].slice(0, 3).forEach(f => {
        const url = URL.createObjectURL(f);
        draftImgs.push(url);
        preview.innerHTML += `<img src="${url}">`;
      });
    };
    publishBtn.onclick = () => {
      if (!currentUser) return alert('è¯·å…ˆç™»å½•');
      const txt = document.getElementById('post-text').value.trim(), place = document.getElementById('post-place').value;
      if (!txt && draftImgs.length === 0) return alert('å†™ç‚¹æ–‡å­—æˆ–é€‰å¼ å›¾ç‰‡å§~');
      addPost({
        id: Date.now(),
        uid: currentUser,
        txt,
        place,
        imgs: [...draftImgs],
        ts: Date.now(),
        views: 0,
        cmts: []
      });
      document.getElementById('post-text').value = '';
      draftImgs = [];
      preview.innerHTML = '';
      document.getElementById('post-place').value = '';
      savePosts();
    };

    /* ---------- åŠ¨æ€æ ¸å¿ƒ ---------- */
    function savePosts() {
      const toSave = posts.map(p => ({ ...p, imgs: [] }));
      store('posts', toSave);
      store(readKey(), [...readIds]);
    }
    function addPost(p) {
      posts.unshift(p);
      if (p.uid === currentUser) readIds.add(p.id);
      renderPosts();
      renderAlbum(currentAlbumMode);
    }
    const MAX_LEN = 120;
    // badgeHTMLï¼šç”¨äºåŠ¨æ€å¸–å­ä¸­åŒæ­¥æ˜¾ç¤ºç”¨æˆ·å‹‹ç« 
    function badgeHTML(uid) {
      const m = store('wear_' + uid);
      if (!m || m === 'none') return '';
      const badge = BADGES.find(b => b.id === m);
      if (!badge) return '';
      if (badge.id === 'best') {
        return `<span class="badge best">${badge.name}</span>`;
      } else if (badge.id === 'catgirl') {
        return `<span class="badge catgirl">${badge.name}</span>`;
      } else {
        return `<span class="badge">${badge.name}</span>`;
      }
    }
    function renderPosts() {
      const list = document.getElementById('moments-list');
      list.innerHTML = '';
      posts.forEach(p => {
        const unread = !readIds.has(p.id) && p.uid !== currentUser,
              isMine = p.uid === currentUser,
              isLong = p.txt.length > MAX_LEN,
              shortTxt = p.txt.slice(0, MAX_LEN) + ' â€¦';
        const card = document.createElement('div');
        card.className = 'post card';
        card.dataset.id = p.id;
        card.innerHTML = `
          <div class="head" style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:34px;height:34px;border-radius:50%;background:url('${store('avatar-' + p.uid) || 'https://placehold.co/60'}') center/cover"></div>
              <b>${displayName(p.uid)}</b>${badgeHTML(p.uid)}${unread ? '<span class="red"></span>' : ''}
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <span style="font-size:12px">${new Date(p.ts).toLocaleTimeString()}</span>
              ${isMine ? '<span class="more del-post">â‹¯</span>' : ''}
            </div>
          </div>
          <div class="body">
            <p class="post-txt ${isLong ? 'folded' : ''}">${isLong ? shortTxt : p.txt}</p>
            ${isLong ? '<span class="toggle">å±•å¼€</span>' : ''}
            <small>${new Date(p.ts).toLocaleDateString()}${p.place ? ' Â· ' + p.place : ''}</small>
          </div>
          <div class="photos">${p.imgs.map(u => `<img src="${u}">`).join('')}</div>
          <div class="actions">
            <svg viewBox="0 0 24 24">
              <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7z m0 12a5 5 0 110-10 5 5 0 010 10z"/>
            </svg>
            <span>${p.views}</span>
          </div>
          <div class="comments">
            ${p.cmts.map((c, i) => `<div class="c" data-idx="${i}" style="display:flex;justify-content:space-between">
                <span>${c.who === 'pet' ? 'ğŸ±' : 'æˆ‘'}ï¼š${c.txt}</span>
                ${isMine && c.who !== 'pet' ? '<span class="more del-c">Ã—</span>' : ''}
              </div>`).join('')}
            <div class="c-input" style="display:flex;gap:8px;margin-top:8px">
              <input placeholder="è¯„è®º..." style="flex:1;border-radius:var(--radius);border:var(--glass-border);padding:6px;background:var(--card-light);backdrop-filter:blur(calc(var(--blur)/2))">
              <button class="btn-publish" style="padding:6px 14px;font-size:13px">å‘é€</button>
            </div>
          </div>`;
        if (isMine) {
          card.querySelector('.del-post').onclick = () => {
            if (confirm('æ’¤å›è¿™æ¡åŠ¨æ€ï¼Ÿ')) {
              posts = posts.filter(x => x.id !== p.id);
              renderPosts();
              renderAlbum(currentAlbumMode);
              savePosts();
            }
          };
          card.querySelectorAll('.del-c').forEach(el => el.onclick = () => {
            const idx = +el.parentNode.dataset.idx;
            p.cmts.splice(idx, 1);
            renderPosts();
            savePosts();
          });
        }
        const ci = card.querySelector('.c-input input'),
              cb = card.querySelector('.c-input button');
        cb.onclick = () => {
          const v = ci.value.trim();
          if (!v) return;
          p.cmts.push({ who: 'me', txt: v });
          ci.value = '';
          renderPosts();
          savePosts();
        };
        if (isLong) {
          card.querySelector('.toggle').onclick = ({ target }) => {
            const pEl = target.previousElementSibling;
            const folded = pEl.classList.toggle('folded');
            pEl.textContent = folded ? shortTxt : p.txt;
            target.textContent = folded ? 'å±•å¼€' : 'æ”¶èµ·';
          };
        }
        list.appendChild(card);
      });
      observePosts();
      renderNavDot();
    }
    let io;
    function observePosts() {
      if (io) io.disconnect();
      io = new IntersectionObserver(es => {
        es.forEach(en => {
          if (en.isIntersecting) {
            const id = +en.target.dataset.id,
                  p = posts.find(x => x.id === id);
            if (p && !readIds.has(id)) {
              readIds.add(id);
              p.views++;
              savePosts();
              renderPosts();
            }
          }
        });
      }, { threshold: .6 });
      $$ ('.post').forEach(c => io.observe(c));
    }
    function renderNavDot() {
      const unread = posts.some(p => !readIds.has(p.id) && p.uid !== currentUser);
      document.getElementById('nav-dot').classList.toggle('hidden', !unread);
    }

    /* ---------- ç›¸å†Œéƒ¨åˆ† ---------- */
    const albumGrid = document.getElementById('album-grid'),
          albumEmpty = document.getElementById('album-empty');
    let currentAlbumMode = 'time';
    function getAllPhotos() {
      const arr = [];
      posts.forEach(p => p.imgs.forEach(u => arr.push({ url: u, place: p.place || 'æœªçŸ¥', date: new Date(p.ts).toISOString().slice(0, 10) })));
      return arr;
    }
    function renderAlbum(mode = 'time') {
      currentAlbumMode = mode;
      const photos = getAllPhotos();
      albumGrid.innerHTML = '';
      const grouped = {};
      photos.forEach(p => {
        const k = mode === 'time' ? p.date.slice(0, 7) : p.place;
        (grouped[k] = grouped[k] || []).push(p);
      });
      Object.entries(grouped).forEach(([k, arr]) => {
        albumGrid.innerHTML += `<h4 style="grid-column:1/-1;margin:4px 0 6px">${k}</h4>`;
        arr.forEach(p => {
          const div = document.createElement('div');
          div.className = 'photo';
          div.innerHTML = `<img src="${p.url}"><span>${p.place}</span>`;
          div.onclick = () => showModal(p.url, `${p.date} Â· ${p.place}`);
          albumGrid.appendChild(div);
        });
      });
      albumEmpty.classList.toggle('hidden', photos.length > 0);
    }
    renderAlbum();
    $$ ('.album-tabs button').forEach(b => b.onclick = () => {
      $$ ('.album-tabs button').forEach(x => x.classList.remove('on'));
      b.classList.add('on');
      renderAlbum(b.dataset.tab);
    });

    /* ---------- Modal ---------- */
    function showModal(src, meta) {
      document.getElementById('mImg').src = src;
      document.getElementById('mMeta').textContent = meta;
      document.getElementById('photoModal').classList.add('show');
    }
    function hideModal() { document.getElementById('photoModal').classList.remove('show'); }
    document.getElementById('photoModal').addEventListener('click', e => { if (e.target.id === 'photoModal') hideModal(); });
    
    /* ---------- å‹‹ç«  Modal & ç®¡ç† ---------- */
    const BADGES = [
      { id: 'none',    name: 'ä¸ä½©æˆ´',         color: '' },
      { id: 'best',    name: 'æœ€å¥½çš„å¤§ä½¬',     color: '' },
      { id: 'catgirl', name: 'ä½ æ‰æ˜¯çŒ«å¨˜',     color: 'linear-gradient(135deg,pink,white)' }
    ];
    // ç”¨äº renderPosts() å†… badgeHTML(uid) åŒæ­¥æ˜¾ç¤º
    function showBadgeModal() {
      renderBadgeOptions();
      document.getElementById('badgeModal').classList.add('show');
    }
    function hideBadgeModal() {
      document.getElementById('badgeModal').classList.remove('show');
    }
    // è¾“å‡ºå‹‹ç«  Modal å†…é€‰é¡¹
    function renderBadgeOptions() {
      const container = document.getElementById('badgeOptions');
      const allowedBadges = BADGES.filter(b => {
        if (b.id === 'best') { return currentUser === 'ç¦»'; }
        return true;
      });
      container.innerHTML = allowedBadges.map(b => {
        let badgeHTMLContent = "";
        if (b.id === 'none') {
          badgeHTMLContent = `<span class="badge badge-none">${b.name}</span>`;
        } else if (b.id === 'best') {
          badgeHTMLContent = `<span class="badge best">${b.name}</span>`;
        } else if (b.id === 'catgirl') {
          badgeHTMLContent = `<span class="badge catgirl">${b.name}</span>`;
        } else {
          badgeHTMLContent = `<span class="badge" style="background:${b.color}">${b.name}</span>`;
        }
        const checked = (store('wear_' + currentUser) === b.id) ||
                        (!store('wear_' + currentUser) && b.id === 'none') ? 'checked' : '';
        return `<label style="display:flex;align-items:center;gap:6px;margin:4px 0">
                  <input type="radio" name="wear" value="${b.id}" ${checked}>
                  ${badgeHTMLContent}
                </label>`;
      }).join('');
    }
    document.getElementById('confirmBadge').onclick = () => {
      const selected = document.querySelector('input[name="wear"]:checked');
      if (selected) {
        store('wear_' + currentUser, selected.value);
        // åé¦ˆæç¤ºï¼šæ˜¾ç¤º toast ä¿¡æ¯
        const toast = document.getElementById('badgeToast');
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 2000);
        renderPosts();
      }
      hideBadgeModal();
    };
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¸ºè®¾ç½®é¡µçš„â€œæ›´æ¢å‹‹ç« â€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    document.getElementById('badge-field').addEventListener('click', function(e) {
      if (e.target && e.target.id === 'changeBadgeBtn') {
        showBadgeModal();
      }
    });

    /* ---------- æ˜µç§°è¾“å…¥æ¡†ä¸ displayName çš„åŒå‘ç»‘å®š ---------- */
    const nameInput = document.getElementById('name-me');
    function syncNameInput() {
      const currentName = displayName(currentUser);
      nameInput.value = currentName;
      const headerNameEl = document.getElementById('header-name');
      if (headerNameEl) {
        headerNameEl.textContent = currentName;
      }
      renderPosts();
    }
    nameInput.addEventListener('input', () => {
      const newName = nameInput.value.trim();
      store('displayName_' + currentUser, newName);
      const headerNameEl = document.getElementById('header-name');
      if (headerNameEl) {
        headerNameEl.textContent = newName;
      }
      renderPosts();
    });
    
    /* ---------- æ›´æ”¹å¯†ç åŠŸèƒ½ ---------- */
    document.getElementById('changePasswordBtn').onclick = () => {
      document.getElementById('passwordModal').classList.add('show');
      document.getElementById('oldPassword').value = "";
      document.getElementById('newPassword').value = "";
      document.getElementById('confirmPassword').value = "";
    };
    document.getElementById('confirmChangePasswordBtn').onclick = () => {
      const oldPwd = document.getElementById('oldPassword').value;
      const newPwd = document.getElementById('newPassword').value;
      const confirmPwd = document.getElementById('confirmPassword').value;
      let storedPwd = store('password_' + currentUser);
      if (!storedPwd) storedPwd = "123456";
      if (oldPwd !== storedPwd) {
        alert("æ—§å¯†ç ä¸æ­£ç¡®ï¼");
        return;
      }
      if (newPwd !== confirmPwd) {
        alert("ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼");
        return;
      }
      if (!newPwd) {
         alert("æ–°å¯†ç ä¸èƒ½ä¸ºç©ºï¼");
         return;
      }
      store('password_' + currentUser, newPwd);
      alert("å¯†ç ä¿®æ”¹æˆåŠŸï¼");
      document.getElementById('passwordModal').classList.remove('show');
    };
    function hidePasswordModal() {
      document.getElementById('passwordModal').classList.remove('show');
    }
    
    /* ---------- åˆå§‹åŒ–ç¤ºä¾‹ & ç™»å½•ååˆå§‹åŒ– ---------- */
    function initAfterLogin() {
      if (!posts.length) {
        addPost({
          id: 1,
          uid: 'Furinya',
          txt: 'æ¬¢è¿å¤§ä½¬~',
          place: 'è’™å¾·åŸ',
          imgs: [],
          ts: Date.now() - 86400000,
          views: 0,
          cmts: []
        });
        savePosts();
      }
      renderPosts();
      renderAlbum(currentAlbumMode);
      syncNameInput();
    }
    if (currentUser) initAfterLogin();
  </script>
</body>
</html>
