<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>把回忆拼好给你</title>
  <style>
    :root {
      --bg-light: #f5f7fa;
      --bg-dark: #0a0a1a; /* 更新后的夜间背景，深蓝色 */
      --card-light: #ffffff33;
      --card-dark: #2b2d3133;
      --blur: 16px;
      --text-light: #222;
      --text-dark: #ddd;
      --primary: #3fa7ff;
      --accent: #ff9e3f;
      --ai-btn-bg: #555;
      --ai-btn-hover-bg: #777;
      --ai-btn-color: #fff;
      --radius: 14px;
      --glass-border: 1px solid rgba(255, 255, 255, .25);
      --select-arrow: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3e%3cpath fill='%23666' d='M0 0l5 6 5-6z'/%3e%3c/svg%3e");
      --select-arrow-dark: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3e%3cpath fill='%23ddd' d='M0 0l5 6 5-6z'/%3e%3c/svg%3e");
      /* 登录窗口专用变量 */
      --login-bg: #f5f7fa;
      --login-text: #222;
      --login-border: rgba(0,0,0,0.2);
    }
    body.dark {
      --login-bg: #1e1f24;
      --login-text: #ddd;
      --login-border: #3a3f47;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Inter, "PingFang SC", sans-serif;
      transition: .3s background-color, .3s color;
    }
    body {
      background: var(--bg-light);
      color: var(--text-light);
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    a {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }
    .hidden { display: none; }

    /* 星空背景 canvas */
    #starCanvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      width: 100%;
      height: 100%;
      display: none;
    }
    /* 仅在暗黑模式下显示星空 */
    body.dark #starCanvas {
      display: block;
    }

    /* ===== 顶栏 ===== */
    nav {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 22px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(var(--blur));
      border-bottom: var(--glass-border);
    }
    .logo {
      font-weight: 700;
      font-size: 20px;
      letter-spacing: .5px;
      text-align: left;
    }
    .menu { display: flex; gap: 18px; align-items: center; }
    .menu a {
      padding: 6px 12px;
      border-radius: 8px;
      transition: .25s background;
    }
    .menu a:hover { background: rgba(0, 0, 0, .08); }
    body.dark .menu a { color: var(--text-dark); }
    .menu a.on { font-weight: 700; text-decoration: underline; }
    .red { width: 8px; height: 8px; border-radius: 50%; background: #e74c3c; margin-left: 4px; }
    .btn-ghost {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 14px; font-size: 14px;
      border-radius: var(--radius);
      border: var(--glass-border);
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      color: inherit; cursor: pointer;
      transition: .25s background;
    }
    .btn-ghost svg { width: 16px; height: 16px; pointer-events: none; }
    .btn-ghost:hover { background: rgba(0, 0, 0, .08); }
    body.dark .btn-ghost { background: rgba(255, 255, 255, .10); }
    body.dark .btn-ghost:hover { background: rgba(255, 255, 255, .18); }
    .btn-publish {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 20px; font-size: 14px;
      border-radius: var(--radius);
      background: var(--ai-btn-bg); color: var(--ai-btn-color);
      border: none; cursor: pointer;
      transition: .25s background;
    }
    .btn-publish:hover { background: var(--ai-btn-hover-bg); }
    .upload-btn { position: relative; overflow: hidden; }
    .upload-btn input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    /* 通用 badge 样式：统一整体尺寸 */
    .badge {
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 4px;
      margin-left: 4px;
      color: #fff;
      display: inline-block;
      min-width: 40px;
      text-align: center;
    }
    .badge.catgirl {
      background: linear-gradient(135deg, #e261a1, #ffb6c1);
      color: #ffffff;
    }
    .badge.best {
      background: linear-gradient(270deg, #3fa7ff, #ff9e3f, #3fa7ff);
      background-size: 400% 400%;
      animation: gradientAnimation 10s ease infinite;
      font-family: 'Orbitron', sans-serif;
      font-weight: normal;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 4px;
    }
    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .badge.badge-none {
      background: none;
      border: 1px dashed #aaa;
      color: #aaa;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 10px;
      min-width: 40px;
    }
    .card {
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      border-radius: var(--radius);
      border: var(--glass-border);
      box-shadow: 0 6px 18px #0001;
      padding: 18px;
    }
    h2.big { margin: 70px 0 22px; font-size: 26px; padding-left: 0; }
    /* ===== 投稿区域 ===== */
    #moments { padding: 40px 8%; }
    #new-post textarea {
      resize: none; height: 78px;
      border-radius: var(--radius);
      border: var(--glass-border);
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      padding: 10px; font-size: 14px; width: 100%;
    }
    #preview img { width: 70px; height: 50px; border-radius: 8px; object-fit: cover; }
    /* ===== 动态列表 ===== */
    #moments-list { display: flex; flex-direction: column; gap: 26px; }
    .post .photos { display: flex; gap: 8px; margin-top: 8px; overflow-x: auto; }
    .post .photos img { width: 96px; height: 68px; border-radius: 8px; object-fit: cover; }
    .post .body p { margin: 0 0 6px; white-space: pre-wrap; line-height: 1.5; }
    .post small { display: block; margin-top: 4px; font-size: 12px; color: #888; }
    .actions { display: flex; gap: 8px; font-size: 13px; margin-top: 8px; align-items: center; color: var(--primary); }
    .actions svg { width: 18px; height: 18px; fill: currentColor; }
    .more { cursor: pointer; font-size: 18px; padding: 2px 6px; border-radius: 50%; transition: .2s background; }
    .more:hover { background: rgba(0, 0, 0, .08); }
    .post-txt.folded { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .toggle { color: var(--primary); cursor: pointer; font-size: 13px; margin-left: 6px; }
    /* ===== 相册 ===== */
    #album { padding: 40px 8%; }
    .album-tabs { display: flex; gap: 16px; margin-bottom: 18px; }
    .album-tabs button {
      background: none; border: none; font-weight: 600; cursor: pointer;
      font-size: 15px; padding: 6px 10px; border-radius: 8px;
      transition: .25s background;
    }
    .album-tabs .on { background: rgba(0, 0, 0, .08); }
    body.dark .album-tabs button { color: var(--text-dark); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 18px; }
    .photo { border-radius: var(--radius); overflow: hidden; position: relative; cursor: pointer; }
    .photo img { width: 100%; height: 120px; object-fit: cover; transition: .3s transform; }
    .photo:hover img { transform: scale(1.05); }
    .photo span { position: absolute; bottom: 6px; left: 6px; background: rgba(0, 0, 0, .45); color: #fff; font-size: 12px; padding: 2px 6px; border-radius: 8px; }
    /* ===== 设置 ===== */
    #settings { padding: 40px 8%; }
    fieldset { border: none; padding: 0; margin: 0 0 24px; }
    legend { font-weight: 600; font-size: 15px; margin-bottom: 8px; }
    .setting-item { display: flex; justify-content: space-between; align-items: center; margin: 12px 0; }
    .setting-item + .setting-item { border-top: 1px solid rgba(0, 0, 0, .08); padding-top: 12px; }
    body.dark .setting-item + .setting-item { border-top: 1px solid rgba(255, 255, 255, .10); }
    .setting-item input[type=text], .setting-item textarea {
      width: 60%; padding: 6px; border-radius: var(--radius);
      border: var(--glass-border);
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      color: inherit;
    }
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding: 6px 34px 6px 12px;
      font-size: 14px;
      border-radius: var(--radius);
      border: var(--glass-border);
      background: var(--card-light);
      color: inherit;
      max-width: 160px;
      background-image: var(--select-arrow);
      background-repeat: no-repeat;
      background-position: right 10px center;
      backdrop-filter: blur(calc(var(--blur) / 2));
    }
    select::-ms-expand { display: none; }
    /* ===== Modal ===== */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: flex; justify-content: center; align-items: center;
      opacity: 0; visibility: hidden;
      transition: opacity 0.25s ease;
    }
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    .box {
      background: var(--card-light); backdrop-filter: blur(var(--blur));
      border: var(--glass-border); border-radius: var(--radius);
      max-width: 600px; width: 90%; max-height: 90vh;
      overflow: auto; padding: 20px; position: relative;
    }
    body.dark .box { background: var(--card-dark); }
    #badgeModal .box { animation: none; }
    .close { position: absolute; top: 10px; right: 16px; font-size: 24px; cursor: pointer; }
    /* ===== 桌宠 ===== */
    #pet { position: fixed; right: 24px; bottom: 24px; width: 90px; user-select: none; cursor: move; z-index: 90; }
    #pet svg { width: 100%; animation: breathe 3s ease-in-out infinite; }
    @keyframes breathe { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    /* ===== 暗黑模式下 ===== */
    body.dark input,
    body.dark textarea,
    body.dark select option {
      background-color: var(--card-dark);
      color: var(--text-dark);
    }
    body.dark input:focus,
    body.dark textarea:focus {
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 5px rgba(255, 255, 255, 0.15);
      outline: none;
    }
    body.dark select:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.2);
    }
    #bubble {
      position: fixed; right: 110px; bottom: 110px; max-width: 220px;
      background: var(--card-light); backdrop-filter: blur(calc(var(--blur) / 2));
      border: var(--glass-border); border-radius: var(--radius);
      padding: 12px; font-size: 14px; line-height: 1.45;
      box-shadow: 0 4px 12px #0003; transition: opacity .4s, transform .4s;
      opacity: 0; transform: translateY(10px); z-index: 95;
    }
    #bubble.show { opacity: 1; transform: translateY(0); }
    /* ============ 评论区域样式 ============ */
    .comments {
      margin-top: 8px;
      padding-top: 4px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    .comment {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 4px 0;
      padding: 6px 8px;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.03);
      font-size: 13px;
    }
    .comment-left {
      flex: 1;
    }
    .comment-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .comment-author {
      font-weight: 600;
    }
    .comment-edit,
    .comment-delete {
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .comment-edit:hover,
    .comment-delete:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .c-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .c-input input {
      flex: 1;
      padding: 6px 10px;
      border-radius: var(--radius);
      border: var(--glass-border);
      background: var(--card-light);
      backdrop-filter: blur(calc(var(--blur) / 2));
      font-size: 14px;
      transition: box-shadow 0.2s;
    }
    .c-input input:focus {
      box-shadow: 0 0 5px rgba(0,0,0,0.15);
    }
    .c-input button {
      padding: 6px 14px;
      font-size: 13px;
      border-radius: var(--radius);
      border: none;
      background: var(--ai-btn-bg);
      color: var(--ai-btn-color);
      cursor: pointer;
      transition: background 0.25s;
    }
    .c-input button:hover {
      background: var(--ai-btn-hover-bg);
    }
    /* ============ 登录 Modal 样式 ============ */
    #loginModal {
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
    }
    #loginModal .box {
      background: var(--login-bg);
      color: var(--login-text);
      border: 1px solid var(--login-border);
      box-shadow: 0 0 20px rgba(63, 167, 255, 0.4);
      border-radius: 10px;
      padding: 30px 20px;
      text-align: center;
      width: 350px;
    }
    #loginModal h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-family: 'Roboto', sans-serif;
    }
    #loginModal .avatar {
      margin: 0 10px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    #loginModal .avatar:hover {
      border-color: var(--primary);
    }
    #loginModal .avatar img {
      width: 90px;
      height: 90px;
      object-fit: cover;
    }
    #loginModal .avatar + .avatar {
      margin-left: 20px;
    }
    #loginModal [data-user] {
      cursor: pointer;
    }
    #loginModal #loginPasswordDiv {
      margin-top: 20px;
    }
    #loginModal input[type="password"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #555;
      background: #2b2d31;
      color: #ddd;
      font-size: 14px;
      margin-bottom: 12px;
    }
    #loginModal .btn-publish {
      font-size: 16px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    #loginModal .btn-publish:hover {
      background: #66baff;
    }
    /* ============ 勋章 Modal ============ */
    #badgeModal .box { animation: none; }
    /* ============ 反馈 Toast ============ */
    #badgeToast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      display: none;
      z-index: 200;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- 星空背景，仅在暗黑模式下显示 -->
  <canvas id="starCanvas"></canvas>
  
  <!-- ===== 顶栏 ===== -->
  <nav>
    <div class="logo">把回忆拼好给你</div>
    <div class="menu">
      <a href="#moments" id="nav-moments">动态<span id="nav-dot" class="red hidden"></span></a>
      <a href="#album">相册</a>
      <a href="#settings">设置</a>
      <span id="header-name" style="font-weight:600;"></span>
      <a id="logout" class="btn-ghost">退出</a>
      <button id="themeBtn" class="btn-ghost">
        <svg id="sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/></svg>
        <svg id="moon" class="hidden" viewBox="0 0 24 24"><path d="M21 12.8A9 9 0 1111.2 3 7 7 0 0021 12.8z"/></svg>
      </button>
    </div>
  </nav>
  
  <!-- ===== 动态（投稿与动态列表） ===== -->
  <section id="moments">
    <h2 class="big">投稿</h2>
    <div id="new-post" class="card" style="display:flex;flex-direction:column;gap:12px">
      <textarea id="post-text" placeholder="说点什么…"></textarea>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <select id="post-place">
          <option value="">无地点</option>
          <option>蒙德</option>
          <option>璃月</option>
          <option>稻妻</option>
          <option>须弥</option>
          <option>枫丹</option>
          <option>纳塔</option>
        </select>
        <label class="btn-ghost upload-btn">
          <svg viewBox="0 0 24 24">
            <path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="post-img" type="file" accept="image/*" multiple>
        </label>
        <button id="publish" class="btn-publish">发布</button>
      </div>
      <div id="preview" style="display:flex;gap:8px;overflow-x:auto"></div>
    </div>
    <h2 class="big">动态</h2>
    <div id="moments-list"></div>
  </section>
  
  <!-- ===== 相册 ===== -->
  <section id="album">
    <h2 class="big">相册</h2>
    <div class="album-tabs">
      <button data-tab="time" class="on">按时间</button>
      <button data-tab="region">按地区</button>
    </div>
    <div id="album-grid" class="grid"></div>
    <div id="album-empty" class="hidden" style="text-align:center;margin-top:30px;color:#888">
      暂无照片，快去上传吧~
    </div>
  </section>
  
  <!-- ===== 设置 ===== -->
  <section id="settings">
    <h2 class="big">设置</h2>
    <div class="card">
      <fieldset>
        <legend>外观</legend>
        <div class="setting-item">
          <span>暗黑模式</span>
          <input type="checkbox" id="theme-toggle">
        </div>
      </fieldset>
      <fieldset>
        <legend>桌宠 / LLM</legend>
        <div class="setting-item">
          <span>显示桌宠</span>
          <input type="checkbox" id="pet-toggle" checked>
        </div>
        <div class="setting-item">
          <span>桌宠类型</span>
          <select id="pet-type">
            <option value="cat">猫娘</option>
            <option value="bird">魈鸟</option>
          </select>
        </div>
        <div class="setting-item">
          <span>启用 LLM</span>
          <input type="checkbox" id="ai-toggle" checked>
        </div>
        <div class="setting-item">
          <span id="prompt-label">桌宠 Prompt</span>
          <input id="pet-prompt" value="喵～ 记得喝水喔！">
        </div>
      </fieldset>
      <fieldset>
        <legend>账户</legend>
        <div class="setting-item">
          <span>头像</span>
          <label class="btn-ghost upload-btn">
            <svg viewBox="0 0 24 24">
              <path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2"/>
            </svg>
            <input id="avatar-input" type="file" accept="image/*">
          </label>
        </div>
        <div class="setting-item">
          <span>我的昵称</span>
          <input id="name-me">
        </div>
        <div class="setting-item">
          <span>更改密码</span>
          <button id="changePasswordBtn" class="btn-ghost">更改密码</button>
        </div>
      </fieldset>
      <fieldset id="badge-field">
        <legend>勋章</legend>
        <div id="currentBadgeDisplay" class="setting-item" style="flex-direction: row; align-items: center;">
          <button id="changeBadgeBtn" class="btn-ghost">更换勋章</button>
        </div>
      </fieldset>
    </div>
  </section>
  
  <!-- ===== 照片 Modal ===== -->
  <div id="photoModal" class="modal">
    <div class="box">
      <span class="close" onclick="hideModal()">×</span>
      <img id="mImg">
      <p id="mMeta" style="margin-top:8px;font-size:14px;color:#888"></p>
    </div>
  </div>
  
  <!-- ===== 登录 Modal ===== -->
  <div id="loginModal" class="modal show">
    <div class="box" style="text-align:center;max-width:340px">
      <h3>选择登录身份</h3>
      <div class="avatar-container" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
        <div class="avatar" data-user="Furinya">
          <img src="https://placehold.co/90x90?text=F" alt="Furinya">
          <div>Furinya</div>
        </div>
        <div class="avatar" data-user="离">
          <img src="https://placehold.co/90x90?text=离" alt="离">
          <div>离</div>
        </div>
      </div>
      <div id="loginPasswordDiv" class="hidden">
        <input type="password" id="loginPassword" placeholder="请输入密码" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;">
        <button id="loginConfirmBtn" class="btn-publish" style="margin-top:12px;">登录</button>
      </div>
    </div>
  </div>
  
  <!-- ===== 勋章 Modal ===== -->
  <div id="badgeModal" class="modal">
    <div class="box">
      <span class="close" onclick="hideBadgeModal()">×</span>
      <h3>选择勋章</h3>
      <div id="badgeOptions" style="margin: 10px 0;"></div>
      <button id="confirmBadge" class="btn-publish" style="margin-top:12px;">确认</button>
    </div>
  </div>
  
  <!-- ===== 更改密码 Modal ===== -->
  <div id="passwordModal" class="modal">
    <div class="box" style="text-align:center;max-width:340px">
      <span class="close" onclick="hidePasswordModal()">×</span>
      <h3>更改密码</h3>
      <div style="margin-top:16px;">
        <input type="password" id="oldPassword" placeholder="旧密码" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;">
        <input type="password" id="newPassword" placeholder="新密码" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;">
        <input type="password" id="confirmPassword" placeholder="确认新密码" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;">
        <button id="confirmChangePasswordBtn" class="btn-publish" style="margin-top:12px;">确认更改</button>
      </div>
    </div>
  </div>
  
  <!-- ===== 桌宠 & 气泡 ===== -->
  <div id="pet"></div>
  <div id="bubble" class="hidden"></div>
  
  <!-- ===== 反馈 Toast ===== -->
  <div id="badgeToast">勋章已更换</div>
  
  <footer style="text-align:center;padding:24px 0;font-size:13px;color:#777">
    © 2025 把回忆拼好给你
  </footer>
  
  <!-- ========= 脚本 ========= -->
  <script>
    /* ---------- 工具函数 ---------- */
    const $ = s => document.querySelector(s),
          $$ = s => document.querySelectorAll(s),
          store = (k, v) => v === undefined ? JSON.parse(localStorage.getItem(k) || 'null') : localStorage.setItem(k, JSON.stringify(v));

    /* ---------- 全局数据 ---------- */
    let posts = store('posts') || [];
    let currentUser = store('currentUser') || null;
    function readKey() { return 'readIds_' + currentUser; }
    let readIds = new Set(store(readKey()) || []);
    
    /* ---------- 显示名称函数 ---------- */
    const displayName = uid => store('displayName_' + uid) || uid;

    /* ---------- 用户登录 ---------- */
    let selectedUser = null;
    $$ ('#loginModal .avatar').forEach(ava => {
      ava.addEventListener('click', () => {
        selectedUser = ava.dataset.user;
        document.getElementById('loginPassword').value = "";
        document.getElementById('loginPasswordDiv').classList.remove('hidden');
      });
    });
    document.getElementById('loginConfirmBtn').onclick = () => {
      const inputPwd = document.getElementById('loginPassword').value;
      let storedPwd = store('password_' + selectedUser);
      if (!storedPwd) {
        storedPwd = "123456";
        store('password_' + selectedUser, storedPwd);
      }
      if (inputPwd === storedPwd) {
        currentUser = selectedUser;
        store('currentUser', currentUser);
        document.getElementById('loginModal').classList.remove('show');
        readIds = new Set(store(readKey()) || []);
        initAfterLogin();
        syncNameInput();
      } else {
        alert("密码不正确，请重试！");
      }
    };

    if (currentUser) {
      document.getElementById('loginModal').classList.remove('show');
    }

    document.getElementById('logout').onclick = () => { 
      localStorage.removeItem('currentUser'); 
      location.reload(); 
    };

    /* ---------- 主题设置 ---------- */
    const body = document.body,
          themeT = document.getElementById('theme-toggle'),
          sun = document.getElementById('sun'),
          moon = document.getElementById('moon');
    function setTheme(dark) {
      body.classList.toggle('dark', dark);
      themeT.checked = dark;
      sun.classList.toggle('hidden', dark);
      moon.classList.toggle('hidden', !dark);
      localStorage.theme = dark ? 'dark' : 'light';
    }
    setTheme(localStorage.theme === 'dark');
    document.getElementById('themeBtn').onclick = () => setTheme(!body.classList.contains('dark'));
    themeT.onchange = () => setTheme(themeT.checked);

    /* ---------- 平滑滚动 & 高亮 ---------- */
    $$('nav .menu a[href^="#"]').forEach(a => a.onclick = e => {
      e.preventDefault();
      document.querySelector(a.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
    });
    const sections = ['moments', 'album', 'settings'].map(id => document.getElementById(id));
    const menuLinks = { moments: document.getElementById('nav-moments'), album: document.querySelector('a[href="#album"]'), settings: document.querySelector('a[href="#settings"]') };
    window.addEventListener('scroll', () => {
      const top = scrollY + 80;
      sections.forEach(sec => {
        const active = top >= sec.offsetTop && top < sec.offsetTop + sec.offsetHeight;
        menuLinks[sec.id].classList.toggle('on', active);
      });
    });

    /* ---------- 桌宠设置 ---------- */
    function lockPetFields() {
      const on = document.getElementById('pet-toggle').checked;
      ['pet-type', 'ai-toggle', 'pet-prompt'].forEach(id => document.getElementById(id).disabled = !on);
    }
    document.getElementById('pet-toggle').onchange = lockPetFields;
    lockPetFields();
    // 修改头像上传，使用 FileReader 转换为 Data URL 存储
    document.getElementById('avatar-input').onchange = e => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const url = e.target.result;
        store('avatar-' + currentUser, url);
        renderAvatars();
        renderPosts();
      };
      reader.readAsDataURL(f);
    };
    function renderAvatars() {
      $$ ('.avatar').forEach(a => {
        const saved = store('avatar-' + a.dataset.user);
        if (saved) a.querySelector('img').src = saved;
      });
    }
    renderAvatars();

    /* ---------- 桌宠代码（略） ---------- */
    const pet = document.getElementById('pet');
    function petSVG(type) {
      return type === 'bird'
        ? `<svg viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="55" fill="#cdeffd" stroke="#333" stroke-width="3"/>
              <path d="M40 70 Q60 90 80 70" stroke="#333" stroke-width="5" fill="none" stroke-linecap="round"/>
              <circle cx="45" cy="55" r="8"/>
              <circle cx="75" cy="55" r="8"/>
            </svg>`
        : `<svg viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="55" fill="#ffe4e1" stroke="#333" stroke-width="3"/>
              <circle cx="45" cy="50" r="10"/>
              <circle cx="75" cy="50" r="10"/>
              <path d="M45 80 Q60 95 75 80" stroke="#333" stroke-width="4" fill="none" stroke-linecap="round"/>
            </svg>`;
    }
    function syncPet() {
      pet.style.display = document.getElementById('pet-toggle').checked ? 'block' : 'none';
      pet.innerHTML = petSVG(document.getElementById('pet-type').value);
    }
    document.getElementById('pet-toggle').onchange = syncPet;
    document.getElementById('pet-type').onchange = syncPet;
    syncPet();
    let ox, oy;
    pet.onmousedown = e => {
      ox = e.offsetX; oy = e.offsetY;
      document.onmousemove = ev => { pet.style.left = ev.pageX - ox + 'px'; pet.style.top = ev.pageY - oy + 'px'; };
      document.onmouseup = () => document.onmousemove = null;
    };

    /* ---------- 上传 / 发布 ---------- */
    const postImg = document.getElementById('post-img'),
          preview = document.getElementById('preview'),
          publishBtn = document.getElementById('publish');
    let draftImgs = [];
    postImg.onchange = e => {
      preview.innerHTML = '';
      draftImgs = [];
      [...e.target.files].slice(0, 3).forEach(f => {
        const url = URL.createObjectURL(f);
        draftImgs.push(url);
        preview.innerHTML += `<img src="${url}">`;
      });
    };
    publishBtn.onclick = () => {
      if (!currentUser) return alert('请先登录');
      const txt = document.getElementById('post-text').value.trim(), place = document.getElementById('post-place').value;
      if (!txt && draftImgs.length === 0) return alert('写点文字或选张图片吧~');
      addPost({
        id: Date.now(),
        uid: currentUser,
        txt,
        place,
        imgs: [...draftImgs],
        ts: Date.now(),
        views: 0,
        cmts: []
      });
      document.getElementById('post-text').value = '';
      draftImgs = [];
      preview.innerHTML = '';
      document.getElementById('post-place').value = '';
      savePosts();
    };

    /* ---------- 动态核心 ---------- */
    function savePosts() {
      const toSave = posts.map(p => ({ ...p, imgs: [] }));
      store('posts', toSave);
      store(readKey(), [...readIds]);
    }
    function addPost(p) {
      posts.unshift(p);
      if (p.uid === currentUser) readIds.add(p.id);
      renderPosts();
      renderAlbum(currentAlbumMode);
    }
    const MAX_LEN = 120;
    // badgeHTML：用于同步显示用户勋章
    function badgeHTML(uid) {
      const m = store('wear_' + uid);
      if (!m || m === 'none') return '';
      const badge = BADGES.find(b => b.id === m);
      if (!badge) return '';
      if (badge.id === 'best') {
        return `<span class="badge best">${badge.name}</span>`;
      } else if (badge.id === 'catgirl') {
        return `<span class="badge catgirl">${badge.name}</span>`;
      } else {
        return `<span class="badge">${badge.name}</span>`;
      }
    }
    function renderPosts() {
      const list = document.getElementById('moments-list');
      list.innerHTML = '';
      posts.forEach(p => {
        const unread = !readIds.has(p.id) && p.uid !== currentUser,
              isMine = p.uid === currentUser,
              isLong = p.txt.length > MAX_LEN,
              shortTxt = p.txt.slice(0, MAX_LEN) + ' …';
        const card = document.createElement('div');
        card.className = 'post card';
        card.dataset.id = p.id;
        card.innerHTML = `
          <div class="head" style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:34px;height:34px;border-radius:50%;background:url('${store('avatar-' + p.uid) || 'https://placehold.co/60'}') center/cover"></div>
              <b>${displayName(p.uid)}</b>${badgeHTML(p.uid)}${unread ? '<span class="red"></span>' : ''}
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <span style="font-size:12px">${new Date(p.ts).toLocaleTimeString()}</span>
              ${isMine ? '<span class="more del-post">⋯</span>' : ''}
            </div>
          </div>
          <div class="body">
            <p class="post-txt ${isLong ? 'folded' : ''}">${isLong ? shortTxt : p.txt}</p>
            ${isLong ? '<span class="toggle">展开</span>' : ''}
            <small>${new Date(p.ts).toLocaleDateString()}${p.place ? ' · ' + p.place : ''}</small>
          </div>
          <div class="photos">${p.imgs.map(u => `<img src="${u}">`).join('')}</div>
          <div class="actions">
            <svg viewBox="0 0 24 24">
              <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7z m0 12a5 5 0 110-10 5 5 0 010 10z"/>
            </svg>
            <span>${p.views}</span>
          </div>
          <div class="comments">
            ${p.cmts.map((c, i) => {
              const canEdit = c.who === currentUser;
              return `
                <div class="comment" data-idx="${i}">
                  <div class="comment-left">
                    <span class="comment-text">${c.txt}</span>
                  </div>
                  <div class="comment-right">
                    ${ canEdit 
                        ? `<span class="comment-edit" title="编辑">✎</span><span class="comment-delete" title="撤回">×</span>`
                        : `<span class="comment-author">${c.who}</span>` }
                  </div>
                </div>
              `;
            }).join('')}
            <div class="c-input">
              <input type="text" placeholder="评论...">
              <button class="btn-publish" style="font-size:13px">发送</button>
            </div>
          </div>`;
        if (isMine) {
          card.querySelector('.del-post').onclick = () => {
            if (confirm('撤回这条动态？')) {
              posts = posts.filter(x => x.id !== p.id);
              renderPosts();
              renderAlbum(currentAlbumMode);
              savePosts();
            }
          };
        }
        if (isLong) {
          card.querySelector('.toggle').onclick = ({ target }) => {
            const pEl = target.previousElementSibling;
            const folded = pEl.classList.toggle('folded');
            pEl.textContent = folded ? shortTxt : p.txt;
            target.textContent = folded ? '展开' : '收起';
          };
        }
        const ci = card.querySelector('.c-input input'),
              cb = card.querySelector('.c-input button');
        cb.onclick = () => {
          const v = ci.value.trim();
          if (!v) return;
          p.cmts.push({ who: currentUser, txt: v });
          ci.value = '';
          renderPosts();
          savePosts();
        };
        card.querySelectorAll('.comment-delete').forEach(btn => {
          btn.onclick = function() {
            const idx = +this.parentNode.parentNode.dataset.idx;
            if (confirm('确定撤回该评论吗？')) {
              p.cmts.splice(idx, 1);
              renderPosts();
              savePosts();
            }
          };
        });
        card.querySelectorAll('.comment-edit').forEach(btn => {
          btn.onclick = function() {
            const idx = +this.parentNode.parentNode.dataset.idx;
            const commentEl = this.parentNode.parentNode.querySelector('.comment-text');
            const oldText = commentEl.textContent;
            const newText = prompt('编辑评论：', oldText);
            if (newText !== null && newText.trim() !== '' && newText !== oldText) {
              p.cmts[idx].txt = newText.trim();
              renderPosts();
              savePosts();
            }
          };
        });
        list.appendChild(card);
      });
      observePosts();
      renderNavDot();
    }
    let io;
    function observePosts() {
      if (io) io.disconnect();
      io = new IntersectionObserver(es => {
        es.forEach(en => {
          if (en.isIntersecting) {
            const id = +en.target.dataset.id,
                  p = posts.find(x => x.id === id);
            if (p && !readIds.has(id)) {
              readIds.add(id);
              p.views++;
              savePosts();
              renderPosts();
            }
          }
        });
      }, { threshold: .6 });
      $$ ('.post').forEach(c => io.observe(c));
    }
    function renderNavDot() {
      const unread = posts.some(p => !readIds.has(p.id) && p.uid !== currentUser);
      document.getElementById('nav-dot').classList.toggle('hidden', !unread);
    }

    /* ---------- 相册部分 ---------- */
    const albumGrid = document.getElementById('album-grid'),
          albumEmpty = document.getElementById('album-empty');
    let currentAlbumMode = 'time';
    function getAllPhotos() {
      const arr = [];
      posts.forEach(p => p.imgs.forEach(u => arr.push({ url: u, place: p.place || '未知', date: new Date(p.ts).toISOString().slice(0, 10) })));
      return arr;
    }
    function renderAlbum(mode = 'time') {
      currentAlbumMode = mode;
      const photos = getAllPhotos();
      albumGrid.innerHTML = '';
      const grouped = {};
      photos.forEach(p => {
        const k = mode === 'time' ? p.date.slice(0, 7) : p.place;
        (grouped[k] = grouped[k] || []).push(p);
      });
      Object.entries(grouped).forEach(([k, arr]) => {
        albumGrid.innerHTML += `<h4 style="grid-column:1/-1;margin:4px 0 6px">${k}</h4>`;
        arr.forEach(p => {
          const div = document.createElement('div');
          div.className = 'photo';
          div.innerHTML = `<img src="${p.url}"><span>${p.place}</span>`;
          div.onclick = () => showModal(p.url, `${p.date} · ${p.place}`);
          albumGrid.appendChild(div);
        });
      });
      albumEmpty.classList.toggle('hidden', photos.length > 0);
    }
    renderAlbum();
    $$ ('.album-tabs button').forEach(b => b.onclick = () => {
      $$ ('.album-tabs button').forEach(x => x.classList.remove('on'));
      b.classList.add('on');
      renderAlbum(b.dataset.tab);
    });

    /* ---------- Modal ---------- */
    function showModal(src, meta) {
      document.getElementById('mImg').src = src;
      document.getElementById('mMeta').textContent = meta;
      document.getElementById('photoModal').classList.add('show');
    }
    function hideModal() { document.getElementById('photoModal').classList.remove('show'); }
    document.getElementById('photoModal').addEventListener('click', e => { if (e.target.id === 'photoModal') hideModal(); });
    
    /* ---------- 勋章 Modal & 管理 ---------- */
    const BADGES = [
      { id: 'none',    name: '不佩戴',         color: '' },
      { id: 'best',    name: '最好的大佬',     color: '' },
      { id: 'catgirl', name: '你才是猫娘',     color: 'linear-gradient(135deg,pink,white)' }
    ];
    function showBadgeModal() {
      renderBadgeOptions();
      document.getElementById('badgeModal').classList.add('show');
    }
    function hideBadgeModal() {
      document.getElementById('badgeModal').classList.remove('show');
    }
    function renderBadgeOptions() {
      const container = document.getElementById('badgeOptions');
      const allowedBadges = BADGES.filter(b => {
        if (b.id === 'best') { return currentUser === '离'; }
        return true;
      });
      container.innerHTML = allowedBadges.map(b => {
        let badgeHTMLContent = "";
        if (b.id === 'none') {
          badgeHTMLContent = `<span class="badge badge-none">${b.name}</span>`;
        } else if (b.id === 'best') {
          badgeHTMLContent = `<span class="badge best">${b.name}</span>`;
        } else if (b.id === 'catgirl') {
          badgeHTMLContent = `<span class="badge catgirl">${b.name}</span>`;
        } else {
          badgeHTMLContent = `<span class="badge" style="background:${b.color}">${b.name}</span>`;
        }
        const checked = (store('wear_' + currentUser) === b.id) ||
                        (!store('wear_' + currentUser) && b.id === 'none') ? 'checked' : '';
        return `<label style="display:flex;align-items:center;gap:6px;margin:4px 0">
                  <input type="radio" name="wear" value="${b.id}" ${checked}>
                  ${badgeHTMLContent}
                </label>`;
      }).join('');
    }
    document.getElementById('confirmBadge').onclick = () => {
      const selected = document.querySelector('input[name="wear"]:checked');
      if (selected) {
        store('wear_' + currentUser, selected.value);
        const toast = document.getElementById('badgeToast');
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 2000);
        renderPosts();
      }
      hideBadgeModal();
    };
    document.getElementById('badge-field').addEventListener('click', function(e) {
      if (e.target && e.target.id === 'changeBadgeBtn') {
        showBadgeModal();
      }
    });

    /* ---------- 昵称输入框与 displayName 的双向绑定 ---------- */
    const nameInput = document.getElementById('name-me');
    function syncNameInput() {
      const currentName = displayName(currentUser);
      nameInput.value = currentName;
      const headerNameEl = document.getElementById('header-name');
      if (headerNameEl) {
        headerNameEl.textContent = currentName;
      }
      renderPosts();
    }
    nameInput.addEventListener('input', () => {
      const newName = nameInput.value.trim();
      store('displayName_' + currentUser, newName);
      const headerNameEl = document.getElementById('header-name');
      if (headerNameEl) {
        headerNameEl.textContent = newName;
      }
      renderPosts();
    });
    
    /* ---------- 更改密码功能 ---------- */
    document.getElementById('changePasswordBtn').onclick = () => {
      document.getElementById('passwordModal').classList.add('show');
      document.getElementById('oldPassword').value = "";
      document.getElementById('newPassword').value = "";
      document.getElementById('confirmPassword').value = "";
    };
    document.getElementById('confirmChangePasswordBtn').onclick = () => {
      const oldPwd = document.getElementById('oldPassword').value;
      const newPwd = document.getElementById('newPassword').value;
      const confirmPwd = document.getElementById('confirmPassword').value;
      let storedPwd = store('password_' + currentUser);
      if (!storedPwd) storedPwd = "123456";
      if (oldPwd !== storedPwd) {
        alert("旧密码不正确！");
        return;
      }
      if (newPwd !== confirmPwd) {
        alert("两次输入的新密码不一致！");
        return;
      }
      if (!newPwd) {
         alert("新密码不能为空！");
         return;
      }
      store('password_' + currentUser, newPwd);
      alert("密码修改成功！");
      document.getElementById('passwordModal').classList.remove('show');
    };
    function hidePasswordModal() {
      document.getElementById('passwordModal').classList.remove('show');
    }
    
    /* ---------- 初始化示例 & 登录后初始化 ---------- */
    function initAfterLogin() {
      if (!posts.length) {
        addPost({
          id: 1,
          uid: 'Furinya',
          txt: '欢迎大佬~',
          place: '蒙德城',
          imgs: [],
          ts: Date.now() - 86400000,
          views: 0,
          cmts: []
        });
        savePosts();
      }
      renderPosts();
      renderAlbum(currentAlbumMode);
      syncNameInput();
    }
    if (currentUser) initAfterLogin();

    function initStarCanvas() {
  const canvas = document.getElementById('starCanvas');
  const ctx = canvas.getContext('2d');

  let stars = [];
  let meteor = null;  // 当前唯一的流星
  let lastMeteorTime = Date.now();

  // 混合模式变量：
  // astronomyBlend：0 表示完全随机漂移；1 表示完全天文旋转模式。
  // targetAstronomy：目标状态，偶尔随机触发为0或1，过渡由blendSpeed平滑进行
  let astronomyBlend = 0;
  let targetAstronomy = 0;

  // 天文模式旋转速度（弧度/帧）—稍微调低，使旋转平缓
  const rotationSpeed = 0.00015;

  // 利用网格+随机抖动生成星星，
  // 每颗星保存两套数据：随机漂移的基础位置与运动速度，以及天文模式所需的极坐标（相对于固定天文中心）。
  function initStars(numStars = 400) {
    stars = [];
    const width = canvas.width;
    const height = canvas.height;
    const gridCount = Math.round(Math.sqrt(numStars));
    const cellW = width / gridCount;
    const cellH = height / gridCount;
    // 固定天文旋转中心（例如水平中心，上部25%位置）
    const astroCenter = { x: width / 2, y: height * 0.25 };
    for (let i = 0; i < gridCount; i++) {
      for (let j = 0; j < gridCount; j++) {
        // 每个格子内随机一个初始位置
        let rx = j * cellW + Math.random() * cellW;
        let ry = i * cellH + Math.random() * cellH;
        // 用于随机模式：保存基本位置，并设定非常慢的漂移速度（较原来降低约10倍）
        const randomX = rx;
        const randomY = ry;
        const dx = (Math.random() - 0.5) * 0.005;
        const dy = (Math.random() - 0.5) * 0.005;
        // 用于天文模式：计算以astroCenter为圆心的极坐标
        const dX = rx - astroCenter.x, dY = ry - astroCenter.y;
        const distance = Math.sqrt(dX * dX + dY * dY);
        const astroAngle = Math.atan2(dY, dX);
        stars.push({
          // 随机模式数据
          randomX: randomX,
          randomY: randomY,
          dx: dx,
          dy: dy,
          // 天文模式数据
          distance: distance,
          astroAngle: astroAngle,
          // 最终绘制位置 (x,y) 初始化取随机模式
          x: randomX,
          y: randomY,
          // 外观参数
          radius: Math.random() * 1.5 + 0.5,
          baseAlpha: Math.random() * 0.5 + 0.5,
          amplitude: Math.random() * 0.3,
          phase: Math.random() * Math.PI * 2,
          brightnessSpeed: Math.random() * 0.001 + 0.0005
        });
      }
    }
    meteor = null;
    lastMeteorTime = Date.now();
  }

  // 单颗流星：从上部随机位置发出，角度约在20°～40°之间（以右下方向为例），
  // 速度较高、拖尾长，使得流星非常明显。
  function spawnMeteor() {
    const width = canvas.width, height = canvas.height;
    const x0 = Math.random() * width;
    const y0 = Math.random() * height * 0.2;
    const angle = (Math.random() * 20 + 20) * Math.PI / 180;
    meteor = {
      x: x0,
      y: y0,
      len: Math.random() * 80 + 80,   // 拖尾长些
      speed: Math.random() * 5 + 12,    // 初始速度高一些
      acceleration: Math.random() * 0.15 + 0.1,
      angle: angle,
      life: 0,
      maxLife: Math.random() * 300 + 500,
      // 轻微曲线扰动，保证整体直线，但看起来自然
      curveAmplitude: Math.random() * 1 + 0.5,
      curveFrequency: Math.random() * 0.002 + 0.001,
      curvePhase: Math.random() * Math.PI * 2
    };
  }

  // 当窗口大小变化时，调整canvas尺寸并重新生成星空数据
  function resize() {
    canvas.width = canvas.parentElement.clientWidth;
    canvas.height = canvas.parentElement.clientHeight;
    initStars(400);
  }
  window.addEventListener('resize', resize);
  resize();

  // 更新模式：每帧小概率随机切换目标状态（0或1），再平滑更新混合系数；
  // 混合系数用于平滑过渡：0为纯随机漂移，1为完全天文模式。
  function updateMode() {
    // 低概率触发目标更新
    if (Math.random() < 0.0005) {
      targetAstronomy = 1;
    } else if (Math.random() < 0.0005) {
      targetAstronomy = 0;
    }
    // 每帧按小步长平滑插值调整，blendSpeed决定过渡速度（这里取 0.002，比较缓慢）
    const blendSpeed = 0.002;
    astronomyBlend += (targetAstronomy - astronomyBlend) * blendSpeed;
  }

  // 动画循环
  function animate() {
    const width = canvas.width, height = canvas.height;
    ctx.clearRect(0, 0, width, height);
    const time = Date.now();
    updateMode();
    // 固定天文模式旋转中心（例如水平中心，上部25%）
    const astroCenter = { x: width / 2, y: height * 0.25 };

    stars.forEach(star => {
      // 随机模式更新：缓慢漂移
      star.randomX += star.dx;
      star.randomY += star.dy;
      if (star.randomX < 0) star.randomX = width;
      if (star.randomX > width) star.randomX = 0;
      if (star.randomY < 0) star.randomY = height;
      if (star.randomY > height) star.randomY = 0;

      // 天文模式更新：以固定旋转中心绕行，角度逐帧加 rotationSpeed
      star.astroAngle += rotationSpeed;
      let astroX = astroCenter.x + star.distance * Math.cos(star.astroAngle);
      let astroY = astroCenter.y + star.distance * Math.sin(star.astroAngle);

      // 计算最终绘制位置，两种模式按 astronomyBlend 混合
      star.x = (1 - astronomyBlend) * star.randomX + astronomyBlend * astroX;
      star.y = (1 - astronomyBlend) * star.randomY + astronomyBlend * astroY;

      // 计算闪烁透明度
      const alpha = star.baseAlpha + star.amplitude * Math.sin(time * star.brightnessSpeed + star.phase);
      const gradient = ctx.createRadialGradient(star.x, star.y, 0, star.x, star.y, star.radius * 3);
      gradient.addColorStop(0, `rgba(255,255,255,${alpha})`);
      gradient.addColorStop(1, "rgba(255,255,255,0)");
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
      ctx.fill();
    });

    // 流星生成：如果当前无流星且距离上一次生成超过15秒，以一定概率生成一颗明显的流星
    if (!meteor && time - lastMeteorTime > 15000 && Math.random() < 0.005) {
      spawnMeteor();
      lastMeteorTime = time;
    }
    if (meteor) {
      meteor.life += 16.67; // 模拟60fps，每帧约16.67ms
      const progress = meteor.life / meteor.maxLife;
      if (progress > 1) {
        meteor = null;
      } else {
        // 更新流星速度
        meteor.speed += meteor.acceleration;
        // 主直线运动
        meteor.x += Math.cos(meteor.angle) * meteor.speed;
        meteor.y += Math.sin(meteor.angle) * meteor.speed;
        // 加入轻微曲线扰动（保持整体直线感）
        const offset = meteor.curveAmplitude * Math.sin(meteor.life * meteor.curveFrequency + meteor.curvePhase);
        meteor.x += -Math.sin(meteor.angle) * offset;
        meteor.y += Math.cos(meteor.angle) * offset;

        // 绘制流星拖尾：线性渐变从不透明到透明
        ctx.beginPath();
        const tailX = meteor.x - Math.cos(meteor.angle) * meteor.len;
        const tailY = meteor.y - Math.sin(meteor.angle) * meteor.len;
        const grad = ctx.createLinearGradient(meteor.x, meteor.y, tailX, tailY);
        grad.addColorStop(0, `rgba(255,255,255,${1 - progress})`);
        grad.addColorStop(1, "rgba(255,255,255,0)");
        ctx.strokeStyle = grad;
        ctx.lineWidth = 2;
        ctx.moveTo(meteor.x, meteor.y);
        ctx.lineTo(tailX, tailY);
        ctx.stroke();
      }
    }

    requestAnimationFrame(animate);
  }
  animate();
}

window.addEventListener('load', initStarCanvas);

  </script>
</body>
</html>
